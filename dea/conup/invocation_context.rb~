# coding: UTF-8
# conup-spi/datamodel
require "steno"
require "steno/core_ext"

module Dea
  class InvocationContext
    
    attr_accessor :rootTx
    attr_accessor :rootComp
    attr_accessor :parentTx
    attr_accessor :parentComp
    
    attr_accessor :subTx
    attr_accessor :subComp
    
    attr_accessor :invokeSequence
    
    def initialize(roottx, rootC, parenttx,parentC,subtx,subC,invoke)
      @rootTx = rootTx
      @rootComp = rootC
      @parentTx = parenttx
      @parentComp = parentC
      @subTx = subtx
      @subComp = subC
      @invocationSequence = invoke
      
    end
    
    
    def to_s
      return "INVOCATION[" + @rootTx+":"+ @rootComp+"," +
             "," + @parentTx+":" + @parentComp +
             "," + @subTx+":" + @subComp+
             "," + @invokeSequence+
             "]"
    end
    
    
    def InvocationContext.getInvocationCtx(ctxString)
      if ctxString == nil
        return
        
      end
      
      if !ctxString.index("INVOCATION_CONTEXT")
        #
      else
        target = getTargetString(ctxString)
        txInfos = target.split(/,/)
        
        rootInfo = txInfos[0]
        parentInfo = txInfos[1]
        subInfo = txInfos[2]
        invoke = txInfos[3]
        
        rootInfos = rootInfo.split(/:/)
        rootTx = (rootInfos[0] != nil) ? rootInfos[0] : nil
        rootComponent = (rootInfos[1] != nil ) ? rootInfos[1] : nil
        
        parentInfos = parentInfo.split(/:/)
        parentTx = (parentInfos[0] != nil)?  parentInfos[0] :nil
        parentComponent = (parentInfos[1] != nil)?  parentInfos[1] : nil
        
        subInfos = subInfo.split(/:/)
        subTx = (subInfos[0] != nil)? subInfos[0] : nil
        subComponent = (subInfos[1] != nil)? subInfos[1] : nil
        
        return InvocationContext.new(rootTx,rootComponent,parentTx,parentComponent,
                                     subTx,subComponent, invoke)
        
      end
    end
    
    def getTargetString(raw)#String
      if raw == nil
        return nil
      end
      
      if /\A\"/=~ raw
        l = raw.length
        raw = raw[1, l-1]
      end  
      
      if /\"\Z/=~ raw
        l2 = raw.length
        raw = raw[0,l2-1]
      end
      
      length = raw.length
      index = raw.index("INVOCATION_CONTEXT")
      sub = raw[index,length-index+1]
      head = sub.index("[") + 1
      tail = sub.index("]")
      
      return raw[head,tail - head + 1]
    end
    
  end
end